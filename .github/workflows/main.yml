name: Build iOS IPA
on: [push]

jobs:
  build:
    runs-on: macos-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Install Dependencies
        run: npm install

      - name: Capacitor Sync
        run: npx cap sync ios

      - name: Build App
        run: |
          # 1. Finde heraus, wo die Projektdatei wirklich liegt
          PATH_TO_WORKSPACE=$(find ios -name "*.xcworkspace" | head -n 1)
          echo "Workspace gefunden unter: $PATH_TO_WORKSPACE"
          
          # 2. Bauen mit festem Zielordner (build-output)
          xcodebuild -workspace "$PATH_TO_WORKSPACE" \
                     -scheme App \
                     -configuration Debug \
                     -sdk iphoneos \
                     -destination 'generic/platform=iOS' \
                     -derivedDataPath build-output \
                     CODE_SIGNING_ALLOWED=NO \
                     CODE_SIGNING_REQUIRED=NO \
                     clean build

      - name: Create Real IPA
        run: |
          # 3. Payload-Ordner f√ºr iOS erstellen
          mkdir -p Payload
          # 4. Die echte .app Datei suchen und in Payload kopieren
          find build-output -name "*.app" -exec cp -r {} Payload/ \;
          # 5. Als IPA zippen
          zip -r NyroxCore.ipa Payload

      - name: Upload Final IPA
        uses: actions/upload-artifact@v4
        with:
          name: NyroxCore-Ready-To-Install
          path: NyroxCore.ipa

      - name: Prepare and Upload App
        run: |
          # Erstellt einen Sammelordner
          mkdir -p exported_app/Payload
          # Sucht die .app Datei und kopiert sie in den Payload-Ordner
          find ~/Library/Developer/Xcode/DerivedData -name "*.app" -exec cp -r {} exported_app/Payload/ \;
          # Zippt es direkt auf dem Server zu einer echten .ipa
          cd exported_app && zip -r ../NyroxCore.ipa Payload
          
      - name: Deliver IPA
        uses: actions/upload-artifact@v4
        with:
          name: NyroxCore-Ready-To-Install
          path: NyroxCore.ipa
