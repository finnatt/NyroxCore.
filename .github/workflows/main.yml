name: Build iOS IPA
on: [push]

jobs:
  build:
    runs-on: macos-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Install Dependencies
        run: npm install

      - name: Capacitor Sync
        run: npx cap sync ios

      - name: Build App
        run: |
          # 1. Suche die Workspace-Datei, egal wo sie liegt
          WORKSPACE=$(find . -name "*.xcworkspace" | head -n 1)
          echo "Workspace gefunden: $WORKSPACE"
          
          # 2. Bauen mit einem festen Zielordner im aktuellen Verzeichnis
          xcodebuild -workspace "$WORKSPACE" \
                     -scheme App \
                     -configuration Debug \
                     -sdk iphoneos \
                     -destination 'generic/platform=iOS' \
                     -derivedDataPath output \
                     CODE_SIGNING_ALLOWED=NO \
                     CODE_SIGNING_REQUIRED=NO \
                     clean build

      - name: Create IPA
        run: |
          # 3. Payload-Ordner erstellen
          mkdir -p Payload
          # 4. Die gebaute .app Datei im 'output' Ordner suchen und kopieren
          APP_PATH=$(find output -name "*.app" | head -n 1)
          cp -r "$APP_PATH" Payload/
          # 5. Als IPA zippen
          zip -r NyroxCore.ipa Payload

      - name: Upload IPA
        uses: actions/upload-artifact@v4
        with:
          name: NyroxCore-IPA-Package
          path: NyroxCore.ipa
